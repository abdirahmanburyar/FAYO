version: '3.8'

services:
  # Infrastructure Services
  postgres:
    image: postgres:15
    container_name: fayo-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: fayo
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d fayo"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: fayo-redis
    ports:
      - '6379:6379'
    networks:
      - fayo-network
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redisdata:/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: fayo-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    ports:
      - '5672:5672'
      - '15672:15672'
    networks:
      - fayo-network
    restart: unless-stopped
    volumes:
      - rabbitmqdata:/var/lib/rabbitmq

  zookeeper:
    image: bitnami/zookeeper:latest
    container_name: fayo-zookeeper
    environment:
      ALLOW_ANONYMOUS_LOGIN: 'yes'
    ports:
      - '2181:2181'
    networks:
      - fayo-network
    restart: unless-stopped
    volumes:
      - zookeeperdata:/bitnami/zookeeper

  kafka:
    image: bitnami/kafka:latest
    container_name: fayo-kafka
    environment:
      KAFKA_CFG_PROCESS_ROLES: 'broker,controller'
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093'
      KAFKA_CFG_LISTENERS: 'PLAINTEXT://:9092,CONTROLLER://:9093'
      KAFKA_CFG_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:9092'
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: 'PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT'
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_CFG_NUM_PARTITIONS: 1
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 1
      ALLOW_PLAINTEXT_LISTENER: 'yes'
    depends_on:
      - zookeeper
    ports:
      - '9092:9092'
    networks:
      - fayo-network
    restart: unless-stopped
    volumes:
      - kafkadata:/bitnami/kafka
    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Application Services
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: fayo-user-service
    ports:
      - '3001:3001'
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/user_service?schema=public}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      PORT: 3001
      SERVICE_NAME: user-service
      OTP_EXPIRES_IN: ${OTP_EXPIRES_IN:-300000}
      OTP_LENGTH: ${OTP_LENGTH:-6}
      EMAIL_USER: ${EMAIL_USER:-}
      EMAIL_PASS: ${EMAIL_PASS:-}
      DEFAULT_EMAIL: ${DEFAULT_EMAIL:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  hospital-service:
    build:
      context: ./services/hospital-service
      dockerfile: Dockerfile
    container_name: fayo-hospital-service
    ports:
      - '3002:3002'
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/hospital_service?schema=public}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      KAFKA_BROKER: kafka:9092
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      PORT: 3002
      SERVICE_NAME: hospital-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_healthy
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  doctor-service:
    build:
      context: ./services/doctor-service
      dockerfile: Dockerfile
    container_name: fayo-doctor-service
    ports:
      - '3003:3003'
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/doctor_service?schema=public}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      PORT: 3003
      SERVICE_NAME: doctor-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  shared-service:
    build:
      context: ./services/shared-service
      dockerfile: Dockerfile
    container_name: fayo-shared-service
    ports:
      - '3004:3004'
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/shared_service?schema=public}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      PORT: 3004
      SERVICE_NAME: shared-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3004/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  gateway:
    build:
      context: ./services/gateway
      dockerfile: Dockerfile
    container_name: fayo-gateway
    ports:
      - '3006:3000'
    environment:
      PORT: 3000
      SERVICE_NAME: gateway
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://localhost:8080}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-fayo}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-fayo-web}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
      KEYCLOAK_CALLBACK_URL: ${KEYCLOAK_CALLBACK_URL:-http://31.97.58.62:3006/auth/keycloak/callback}
      USER_SERVICE_URL: http://user-service:3001
      TRIAGE_SERVICE_URL: ${TRIAGE_SERVICE_URL:-http://localhost:3003}
      NOTIFICATION_SERVICE_URL: http://notification-worker:3007
    depends_on:
      - user-service
      - hospital-service
      - doctor-service
      - shared-service
      - notification-worker
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  notification-worker:
    build:
      context: ./services/notification-worker
      dockerfile: Dockerfile
    container_name: fayo-notification-worker
    ports:
      - '3007:3007'
    environment:
      PORT: 3007
      SERVICE_NAME: notification-worker
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      SMS_API_KEY: ${SMS_API_KEY:-}
      SMS_API_URL: ${SMS_API_URL:-}
    depends_on:
      - rabbitmq
      - redis
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3007/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  admin-panel:
    build:
      context: ./web/admin-panel
      dockerfile: Dockerfile
    container_name: fayo-admin-panel
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://31.97.58.62:3006}
    depends_on:
      - gateway
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  fayo-network:
    driver: bridge

volumes:
  pgdata:
  redisdata:
  rabbitmqdata:
  zookeeperdata:
  kafkadata:

