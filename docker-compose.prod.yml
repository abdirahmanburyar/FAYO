# version is obsolete in newer Docker Compose versions

services:
  # Infrastructure Services
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: fayo
      # PostgreSQL performance optimizations
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    command:
      - postgres
      - -c
      - shared_buffers=128MB
      - -c
      - effective_cache_size=512MB
      - -c
      - maintenance_work_mem=64MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=8MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - work_mem=2MB
      - -c
      - min_wal_size=512MB
      - -c
      - max_wal_size=2GB
      - -c
      - max_connections=50
      - -c
      - max_worker_processes=2
      - -c
      - max_parallel_workers_per_gather=1
      - -c
      - max_parallel_workers=2
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - fayo-network
    restart: unless-stopped
    mem_limit: 1g
    mem_reservation: 512m
    cpu_quota: 100000
    cpu_period: 100000
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - '6379:6379'
    networks:
      - fayo-network
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory 192mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
    mem_limit: 384m
    mem_reservation: 192m
    cpu_quota: 50000
    cpu_period: 100000
    volumes:
      - redisdata:/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    ports:
      - '5672:5672'
      - '15672:15672'
    networks:
      - fayo-network
    restart: unless-stopped
    mem_limit: 384m
    mem_reservation: 192m
    cpu_quota: 50000
    cpu_period: 100000
    volumes:
      - rabbitmqdata:/var/lib/rabbitmq

  # Database Migration Service (runs once before api-service)
  api-migration:
    build:
      context: ./services/api-service
      dockerfile: Dockerfile
    container_name: api-migration
    environment:
      NODE_ENV: production
      # Unified database with multiple schemas
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/fayo}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - fayo-network
    restart: "no"
    entrypoint: ["/bin/sh", "/app/scripts/migrate.sh"]
    profiles:
      - migration

  # Application Services
  api-service:
    build:
      context: ./services/api-service
      dockerfile: Dockerfile
    container_name: api-service
    ports:
      - '3001:3001'
    mem_limit: 512m
    mem_reservation: 256m
    cpu_quota: 75000
    cpu_period: 100000
    environment:
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=384"
      # Unified database with multiple schemas
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/fayo}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      # Server Configuration
      HOST: 0.0.0.0
      PORT: 3001
      SERVICE_NAME: api-service
      # OTP Configuration
      OTP_EXPIRES_IN: ${OTP_EXPIRES_IN:-300000}
      OTP_LENGTH: ${OTP_LENGTH:-6}
      # Email Configuration
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-buryar313@gmail.com}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-fjmnakpupnytzsah}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-buryar313@gmail.com}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-FAYO Healthcare}
      DEFAULT_EMAIL: ${DEFAULT_EMAIL:-buryar313@gmail.com}
      # Zoom Configuration
      ZOOM_SDK_KEY: ${ZOOM_SDK_KEY:-}
      ZOOM_SDK_SECRET: ${ZOOM_SDK_SECRET:-}
      # Payment Configuration
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://72.62.51.50:3001}
      ADMIN_PANEL_URL: ${ADMIN_PANEL_URL:-http://localhost:3000}
      # Waafipay Configuration
      WAAFIPAY_ENV: ${WAAFIPAY_ENV:-sandbox}
      WAAFIPAY_API_URL: ${WAAFIPAY_API_URL:-https://api.waafipay.com/asm}
      WAAFIPAY_MERCHANT_UID: ${WAAFIPAY_MERCHANT_UID:-M0913664}
      WAAFIPAY_API_USER_ID: ${WAAFIPAY_API_USER_ID:-1007468}
      WAAFIPAY_API_KEY: ${WAAFIPAY_API_KEY:-API-1101188487AHX}
      WAAFIPAY_ACCOUNT_NUMBER: ${WAAFIPAY_ACCOUNT_NUMBER:-}
      WAAFIPAY_PHONE_NUMBER: ${WAAFIPAY_PHONE_NUMBER:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_started
    networks:
      - fayo-network
    restart: unless-stopped
    volumes:
      - api_uploads:/app/uploads
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 60s

  admin-panel:
    build:
      context: ./web/admin-panel
      dockerfile: Dockerfile
    container_name: admin-panel
    ports:
      - '3000:3000'
    mem_limit: 384m
    mem_reservation: 192m
    cpu_quota: 50000
    cpu_period: 100000
    environment:
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=256"
      # Server-side URLs (for API routes) - use Docker service name
      API_SERVICE_URL: ${API_SERVICE_URL:-http://api-service:3001}
      # Client-side URLs (for browser) - use external IP or domain
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://72.62.51.50:3001/api/v1}
    depends_on:
      - api-service
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 90s

networks:
  fayo-network:
    driver: bridge

volumes:
  pgdata:
  redisdata:
  rabbitmqdata:
  api_uploads:

