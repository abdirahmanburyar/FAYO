# version is obsolete in newer Docker Compose versions

services:
  # Infrastructure Services
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: fayo
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - '6379:6379'
    networks:
      - fayo-network
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redisdata:/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    ports:
      - '5672:5672'
      - '15672:15672'
    networks:
      - fayo-network
    restart: unless-stopped
    volumes:
      - rabbitmqdata:/var/lib/rabbitmq

  # Application Services
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - '3001:3001'
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/user_service?schema=users}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      PORT: 3001
      SERVICE_NAME: user-service
      OTP_EXPIRES_IN: ${OTP_EXPIRES_IN:-300000}
      OTP_LENGTH: ${OTP_LENGTH:-6}
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-buryar313@gmail.com}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-fjmnakpupnytzsah}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-buryar313@gmail.com}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-FAYO Healthcare}
      DEFAULT_EMAIL: ${DEFAULT_EMAIL:-buryar313@gmail.com}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://72.62.51.50:3001/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  hospital-service:
    build:
      context: ./services/hospital-service
      dockerfile: Dockerfile
    container_name: hospital-service
    ports:
      - '3002:3002'
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/hospital_service?schema=hospitals}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      HOST: 0.0.0.0
      PORT: 3002
      SERVICE_NAME: hospital-service
      SPECIALTY_SERVICE_URL: ${SPECIALTY_SERVICE_URL:-http://specialty-service:3004}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      specialty-service:
        condition: service_healthy
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - admin_uploads:/app/uploads

  doctor-service:
    build:
      context: ./services/doctor-service
      dockerfile: Dockerfile
    container_name: doctor-service
    ports:
      - '3003:3003'
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/doctor_service?schema=public}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      HOST: 0.0.0.0
      PORT: 3003
      SERVICE_NAME: doctor-service
      SPECIALTY_SERVICE_URL: ${SPECIALTY_SERVICE_URL:-http://specialty-service:3004}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      specialty-service:
        condition: service_healthy
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - admin_uploads:/app/uploads

  specialty-service:
    build:
      context: ./services/specialty-service
      dockerfile: Dockerfile
    container_name: specialty-service
    ports:
      - '3004:3004'
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/specialty_service?schema=public}
      HOST: 0.0.0.0
      PORT: 3004
      SERVICE_NAME: specialty-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3004/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  appointment-service:
    build:
      context: ./services/appointment-service
      dockerfile: Dockerfile
    container_name: appointment-service
    ports:
      - '3005:3005'
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/appointment_service?schema=appointments}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      HOST: 0.0.0.0
      PORT: 3005
      SERVICE_NAME: appointment-service
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:3001}
      HOSPITAL_SERVICE_URL: ${HOSPITAL_SERVICE_URL:-http://hospital-service:3002}
      DOCTOR_SERVICE_URL: ${DOCTOR_SERVICE_URL:-http://doctor-service:3003}
      ZOOM_SDK_KEY: ${ZOOM_SDK_KEY:-}
      ZOOM_SDK_SECRET: ${ZOOM_SDK_SECRET:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      user-service:
        condition: service_healthy
      hospital-service:
        condition: service_healthy
      doctor-service:
        condition: service_healthy
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3005/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ads-service:
    build:
      context: ./services/ads-service
      dockerfile: Dockerfile
    container_name: ads-service
    ports:
      - '3007:3007'
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/ads_service?schema=ads}
      HOST: 0.0.0.0
      PORT: 3007
      SERVICE_NAME: ads-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - fayo-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3007/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  payment-service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - '3006:3006'
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/payment_service?schema=payments}
      PORT: 3006
      HOST: 0.0.0.0
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://72.62.51.50:3001}
      ADMIN_PANEL_URL: ${ADMIN_PANEL_URL:-http://localhost:3000}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      # Waafipay Configuration
      WAAFIPAY_ENV: ${WAAFIPAY_ENV:-sandbox}
      WAAFIPAY_API_URL: ${WAAFIPAY_API_URL:-https://api.waafipay.com/asm}
      WAAFIPAY_MERCHANT_UID: ${WAAFIPAY_MERCHANT_UID:-M0913664}
      WAAFIPAY_API_USER_ID: ${WAAFIPAY_API_USER_ID:-1007468}
      WAAFIPAY_API_KEY: ${WAAFIPAY_API_KEY:-API-1101188487AHX}
      WAAFIPAY_ACCOUNT_NUMBER: ${WAAFIPAY_ACCOUNT_NUMBER:-}
      WAAFIPAY_PHONE_NUMBER: ${WAAFIPAY_PHONE_NUMBER:-}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3006/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  admin-panel:
    build:
      context: ./web/admin-panel
      dockerfile: Dockerfile
    container_name: admin-panel
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      # Server-side URLs (for API routes) - use Docker service names
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:3001}
      HOSPITAL_SERVICE_URL: ${HOSPITAL_SERVICE_URL:-http://hospital-service:3002}
      DOCTOR_SERVICE_URL: ${DOCTOR_SERVICE_URL:-http://doctor-service:3003}
      SPECIALTY_SERVICE_URL: ${SPECIALTY_SERVICE_URL:-http://specialty-service:3004}
      APPOINTMENT_SERVICE_URL: ${APPOINTMENT_SERVICE_URL:-http://appointment-service:3005}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL:-http://payment-service:3006}
      ADS_SERVICE_URL: ${ADS_SERVICE_URL:-http://ads-service:3007}
      # Client-side URLs (for browser) - use external IP or domain
      NEXT_PUBLIC_USER_SERVICE_URL: ${NEXT_PUBLIC_USER_SERVICE_URL:-http://72.62.51.50:3001}
      NEXT_PUBLIC_HOSPITAL_SERVICE_URL: ${NEXT_PUBLIC_HOSPITAL_SERVICE_URL:-http://72.62.51.50:3002}
      NEXT_PUBLIC_DOCTOR_SERVICE_URL: ${NEXT_PUBLIC_DOCTOR_SERVICE_URL:-http://72.62.51.50:3003}
      NEXT_PUBLIC_SPECIALTY_SERVICE_URL: ${NEXT_PUBLIC_SPECIALTY_SERVICE_URL:-http://72.62.51.50:3004}
      NEXT_PUBLIC_APPOINTMENT_SERVICE_URL: ${NEXT_PUBLIC_APPOINTMENT_SERVICE_URL:-http://72.62.51.50:3005}
      NEXT_PUBLIC_PAYMENT_SERVICE_URL: ${NEXT_PUBLIC_PAYMENT_SERVICE_URL:-http://72.62.51.50:3006}
      NEXT_PUBLIC_ADS_SERVICE_URL: ${NEXT_PUBLIC_ADS_SERVICE_URL:-http://72.62.51.50:3007}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://72.62.51.50:3001/api/v1}
    depends_on:
      - user-service
      - hospital-service
      - doctor-service
      - specialty-service
      - appointment-service
      - payment-service
      - ads-service
    networks:
      - fayo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  fayo-network:
    driver: bridge

volumes:
  pgdata:
  redisdata:
  rabbitmqdata:
  admin_uploads:

