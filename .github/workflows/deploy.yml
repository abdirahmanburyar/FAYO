name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  VPS_HOST: 31.97.58.62
  VPS_USER: root
  DOCKER_COMPOSE_VERSION: 2.24.0

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            services/*/package-lock.json
            web/*/package-lock.json

      - name: Install dependencies and build services
        run: |
          echo "üîç Checking service dependencies..."
          for service in services/*/; do
            if [ -f "$service/package.json" ]; then
              service_name=$(basename "$service")
              echo "üì¶ Installing dependencies for $service_name..."
              cd "$service"
              if ! npm ci --legacy-peer-deps 2>/dev/null; then
                echo "‚ö†Ô∏è Lock file out of sync, updating with npm install..."
                npm install --legacy-peer-deps || npm install --force
              fi
              echo "‚úÖ $service_name dependencies installed"
              cd ../..
            fi
          done
          
          # Handle web/admin-panel if it exists
          if [ -f "web/admin-panel/package.json" ]; then
            echo "üì¶ Installing dependencies for web/admin-panel..."
            cd web/admin-panel
            if ! npm ci --legacy-peer-deps 2>/dev/null; then
              echo "‚ö†Ô∏è Lock file out of sync, updating with npm install..."
              npm install --legacy-peer-deps || npm install --force
            fi
            echo "‚úÖ web/admin-panel dependencies installed"
            cd ../..
          fi

      - name: Lint code
        run: |
          echo "üîç Running lint checks..."
          # Add your linting commands here if needed
          # npm run lint

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y sshpass

      - name: Check VPS Password Secret
        run: |
          if [ -z "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            echo "::error::VPS_SSH_PASSWORD secret is not set!"
            echo "Please add the VPS password as a GitHub secret:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: VPS_SSH_PASSWORD"
            echo "4. Value: Buryar@2020#"
            echo "5. Click 'Add secret'"
            exit 1
          fi
          echo "‚úÖ VPS password secret is configured"

      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          chmod 600 ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          echo "üîå Testing SSH connection..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=10 \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "echo '‚úÖ SSH connection successful'"
        continue-on-error: false

      - name: Install Docker and Docker Compose on VPS
        run: |
          echo "üê≥ Installing Docker and Docker Compose..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=30 \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            bash -s << 'ENDSSH'
              set -e
              
              # Install Docker if not present
              if ! command -v docker &> /dev/null; then
                echo "Installing Docker..."
                curl -fsSL https://get.docker.com -o get-docker.sh
                sh get-docker.sh
                systemctl enable docker
                systemctl start docker
                sleep 5
              else
                echo "Docker is already installed"
              fi
              
              # Install Docker Compose if not present
              if ! docker compose version &> /dev/null && ! command -v docker-compose &> /dev/null; then
                echo "Installing Docker Compose..."
                apt-get update -qq
                apt-get install -y docker-compose-plugin 2>/dev/null || {
                  echo "Installing standalone docker-compose as fallback..."
                  COMPOSE_VERSION="v2.24.0"
                  ARCH=$(uname -m)
                  if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
                    ARCH="aarch64"
                  else
                    ARCH="x86_64"
                  fi
                  curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-linux-${ARCH}" \
                    -o /usr/local/bin/docker-compose 2>/dev/null
                  chmod +x /usr/local/bin/docker-compose
                }
              else
                echo "Docker Compose is already installed"
              fi
              
              # Verify installations
              echo "Verifying installations..."
              docker --version
              if docker compose version &> /dev/null; then
                echo "Using Docker Compose plugin:"
                docker compose version
              elif command -v docker-compose &> /dev/null; then
                echo "Using standalone docker-compose:"
                docker-compose --version
              fi
            ENDSSH

      - name: Create deployment directory on VPS
        run: |
          echo "üìÅ Creating deployment directory..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=10 \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            'mkdir -p /opt/fayo/{services,web,scripts} && echo "‚úÖ Directories created"'

      - name: Copy files to VPS
        run: |
          set -e
          
          echo "üì§ Copying files to VPS..."
          
          # Copy docker-compose file
          echo "  ‚Üí Copying docker-compose.prod.yml..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            scp -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=30 \
                docker-compose.prod.yml \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/opt/fayo/ 2>/dev/null
          
          # Create and copy services archive
          echo "  ‚Üí Creating services archive..."
          tar --exclude='node_modules' \
              --exclude='dist' \
              --exclude='.git' \
              --exclude='*.log' \
              --exclude='*.tar.gz' \
              -czf services.tar.gz services/ || true
          
          echo "  ‚Üí Copying services archive..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            scp -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=60 \
                services.tar.gz \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/opt/fayo/ 2>/dev/null
          
          echo "  ‚Üí Extracting services archive on VPS..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=30 \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            'cd /opt/fayo && tar -xzf services.tar.gz && rm -f services.tar.gz && echo "‚úÖ Services extracted"'
          
          rm -f services.tar.gz
          
          # Handle web directory
          if [ -d "web" ]; then
            echo "  ‚Üí Creating web archive..."
            tar --exclude='node_modules' \
                --exclude='.next' \
                --exclude='.git' \
                --exclude='*.log' \
                --exclude='*.tar.gz' \
                -czf web.tar.gz web/ || true
            
            echo "  ‚Üí Copying web archive..."
            sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
              scp -o StrictHostKeyChecking=no \
                  -o LogLevel=ERROR \
                  -o ConnectTimeout=60 \
                  web.tar.gz \
                  ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/opt/fayo/ 2>/dev/null
            
            echo "  ‚Üí Extracting web archive on VPS..."
            sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
              ssh -o StrictHostKeyChecking=no \
                  -o LogLevel=ERROR \
                  -o ConnectTimeout=30 \
                  ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
              'cd /opt/fayo && tar -xzf web.tar.gz && rm -f web.tar.gz && echo "‚úÖ Web extracted"'
            
            rm -f web.tar.gz
          fi
          
          # Handle scripts
          if [ -d "scripts" ]; then
            echo "  ‚Üí Creating scripts archive..."
            tar --exclude='*.tar.gz' -czf scripts.tar.gz scripts/ || true
            
            echo "  ‚Üí Copying scripts archive..."
            sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
              scp -o StrictHostKeyChecking=no \
                  -o LogLevel=ERROR \
                  -o ConnectTimeout=30 \
                  scripts.tar.gz \
                  ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/opt/fayo/ 2>/dev/null
            
            echo "  ‚Üí Extracting scripts archive on VPS..."
            sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
              ssh -o StrictHostKeyChecking=no \
                  -o LogLevel=ERROR \
                  -o ConnectTimeout=30 \
                  ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
              'cd /opt/fayo && tar -xzf scripts.tar.gz && rm -f scripts.tar.gz && echo "‚úÖ Scripts extracted"'
            
            rm -f scripts.tar.gz
          fi
          
          echo "‚úÖ All files copied successfully"

      - name: Create .env file on VPS
        run: |
          echo "‚öôÔ∏è Creating .env file on VPS..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=10 \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            bash -s << 'ENDSSH'
              cd /opt/fayo
              if [ ! -f .env ]; then
                echo "Creating new .env file..."
                cat > .env << 'ENVEOF'
# Database
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/fayo?schema=public

# Redis
REDIS_PASSWORD=

# RabbitMQ
RABBITMQ_USER=guest
RABBITMQ_PASS=guest

# JWT
JWT_SECRET=your-super-secret-jwt-key-change-in-production-CHANGE-THIS

# OTP
OTP_EXPIRES_IN=300000
OTP_LENGTH=6

# Email (configure these)
EMAIL_USER=
EMAIL_PASS=
DEFAULT_EMAIL=

# SMS (configure these)
SMS_API_KEY=
SMS_API_URL=

# Keycloak (configure these)
KEYCLOAK_URL=http://localhost:8080
KEYCLOAK_REALM=fayo
KEYCLOAK_CLIENT_ID=fayo-web
KEYCLOAK_CLIENT_SECRET=
KEYCLOAK_CALLBACK_URL=http://31.97.58.62:3006/auth/keycloak/callback

# API URLs
NEXT_PUBLIC_API_URL=http://31.97.58.62:3006
ENVEOF
                echo "‚úÖ .env file created"
              else
                echo "‚ÑπÔ∏è .env file already exists, skipping creation"
              fi
            ENDSSH

      - name: Deploy with Docker Compose
        run: |
          echo "üöÄ Deploying services with Docker Compose..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=30 \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            bash -s << 'ENDSSH'
              set -e
              cd /opt/fayo
              
              # Determine which compose command to use
              if docker compose version &> /dev/null; then
                COMPOSE_CMD="docker compose"
                echo "Using Docker Compose plugin"
              elif command -v docker-compose &> /dev/null; then
                COMPOSE_CMD="docker-compose"
                echo "Using standalone docker-compose"
              else
                echo "‚ùå Docker Compose not found!"
                exit 1
              fi
              
              # Stop existing containers
              echo "Stopping existing containers..."
              $COMPOSE_CMD -f docker-compose.prod.yml down || true
              
              # Build images
              echo "Building Docker images..."
              $COMPOSE_CMD -f docker-compose.prod.yml build --no-cache
              
              # Start services
              echo "Starting services..."
              $COMPOSE_CMD -f docker-compose.prod.yml up -d
              
              # Wait a bit for services to initialize
              sleep 10
              
              # Show container status
              echo "=== Container Status ==="
              $COMPOSE_CMD -f docker-compose.prod.yml ps
              
              echo ""
              echo "=== Docker Container List ==="
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            ENDSSH

      - name: Wait for services to be healthy
        run: |
          echo "üè• Waiting for services to be healthy..."
          sshpass -p "${{ secrets.VPS_SSH_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=10 \
                ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            bash -s << 'ENDSSH'
              echo "Waiting 30 seconds for services to initialize..."
              sleep 30
              
              echo "Checking service health endpoints..."
              HEALTH_CHECK_PASSED=0
              HEALTH_CHECK_FAILED=0
              
              for port in 3000 3001 3002 3003 3004 3006 3007; do
                echo -n "Checking port $port... "
                if timeout 15 bash -c "until curl -sf http://localhost:$port/api/v1/health 2>/dev/null || curl -sf http://localhost:$port/health 2>/dev/null; do sleep 2; done" 2>/dev/null; then
                  echo "‚úÖ Healthy"
                  HEALTH_CHECK_PASSED=$((HEALTH_CHECK_PASSED + 1))
                else
                  echo "‚ö†Ô∏è Not responding (may still be starting)"
                  HEALTH_CHECK_FAILED=$((HEALTH_CHECK_FAILED + 1))
                fi
              done
              
              echo ""
              echo "Health check summary: $HEALTH_CHECK_PASSED passed, $HEALTH_CHECK_FAILED not yet ready"
              
              if [ $HEALTH_CHECK_PASSED -gt 0 ]; then
                echo "‚úÖ At least some services are healthy"
              else
                echo "‚ö†Ô∏è No services responded to health checks yet (they may still be starting)"
              fi
            ENDSSH
        continue-on-error: true

      - name: Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **VPS IP**: \`${{ env.VPS_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Admin Panel | http://${{ env.VPS_HOST }}:3000 |" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | http://${{ env.VPS_HOST }}:3006 |" >> $GITHUB_STEP_SUMMARY
          echo "| User Service | http://${{ env.VPS_HOST }}:3001 |" >> $GITHUB_STEP_SUMMARY
          echo "| Hospital Service | http://${{ env.VPS_HOST }}:3002 |" >> $GITHUB_STEP_SUMMARY
          echo "| Doctor Service | http://${{ env.VPS_HOST }}:3003 |" >> $GITHUB_STEP_SUMMARY
          echo "| Shared Service | http://${{ env.VPS_HOST }}:3004 |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification Worker | http://${{ env.VPS_HOST }}:3007 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify services are running: \`ssh root@${{ env.VPS_HOST }} 'cd /opt/fayo && docker compose ps'\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check logs if needed: \`ssh root@${{ env.VPS_HOST }} 'cd /opt/fayo && docker compose logs'\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Update production .env file with actual credentials" >> $GITHUB_STEP_SUMMARY
