name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå Error: VPS_HOST secret is not set!!"
            echo "Please add VPS_HOST secret in GitHub repository settings."
            exit 1
          fi
          if [ -z "${{ secrets.VPS_PASSWORD }}" ]; then
            echo "‚ùå Error: VPS_PASSWORD secret is not set!"
            echo "Please add VPS_PASSWORD secret in GitHub repository settings."
            exit 1
          fi
          echo "‚úÖ Secrets validated successfully"
          echo "VPS Host: ${{ secrets.VPS_HOST }}"

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Create directory and .env file on VPS
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
          mkdir -p /root/fayo
          if [ ! -f /root/fayo/.env ]; then
            echo "Creating .env file..."
            touch /root/fayo/.env
          else
            echo ".env file already exists"
          fi
          EOF

      - name: Copy files to VPS
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} "mkdir -p /root/fayo"
          sshpass -p '${{ secrets.VPS_PASSWORD }}' rsync -avz -e "ssh -o StrictHostKeyChecking=no" \
            --exclude '.git' --exclude 'node_modules' --exclude 'dist' \
            --exclude 'mobile' \
            ./ root@${{ secrets.VPS_HOST }}:/root/fayo/
          echo "‚úÖ Files copied (including .env files)"

      - name: Deploy to VPS
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
          cd /root/fayo
          
          # Check if Docker Compose is available
          if ! command -v docker &> /dev/null; then
            echo "‚ùå Docker is not installed!"
            exit 1
          fi
          
          # Try docker compose (V2), fallback to docker-compose (V1) if needed
          if docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
            echo "Using Docker Compose V2"
          elif command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
            echo "Using Docker Compose V1"
          else
            echo "‚ùå Docker Compose is not installed!"
            echo "Installing Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "Building Docker images (all services including admin-panel)..."
          $COMPOSE_CMD -f docker-compose.prod.yml pull || true
          $COMPOSE_CMD -f docker-compose.prod.yml build
          
          # Verify admin-panel image was built
          if docker images --format "{{.Repository}}" | grep -q "fayo-admin-panel\|admin-panel"; then
            echo "‚úÖ admin-panel image built successfully"
          else
            echo "‚ö†Ô∏è  Warning: admin-panel image not found, but continuing..."
          fi
          
          echo "Starting infrastructure services first..."
          $COMPOSE_CMD -f docker-compose.prod.yml up -d postgres redis rabbitmq
          
          echo "Waiting for infrastructure to be ready..."
          sleep 30
          
          # Wait for PostgreSQL to be fully ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if docker exec postgres pg_isready -U postgres > /dev/null 2>&1; then
              echo "‚úÖ PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done
          
          echo ""
          echo "=========================================="
          echo "üóÑÔ∏è  Creating Required Databases"
          echo "=========================================="
          
          # Function to create database if it doesn't exist
          create_database() {
            local DB_NAME=$1
            echo "  ‚Üí Creating database: $DB_NAME"
            if docker exec postgres psql -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$DB_NAME'" | grep -q 1; then
              echo "    ‚ÑπÔ∏è  Database $DB_NAME already exists"
            else
              docker exec postgres psql -U postgres -c "CREATE DATABASE $DB_NAME;" && \
              echo "    ‚úÖ Database $DB_NAME created successfully"
            fi
          }
          
          # Create all service databases
          create_database "user_service"
          create_database "hospital_service"
          create_database "doctor_service"
          create_database "specialty_service"
          create_database "appointment_service"
          create_database "ads_service"
          create_database "payment_service"
          
          echo ""
          echo "Creating schemas..."
          # Hospital service uses multi-schema with "hospitals" schema
          echo "  ‚Üí Creating 'hospitals' schema in hospital_service..."
          docker exec postgres psql -U postgres -d hospital_service -c 'CREATE SCHEMA IF NOT EXISTS "hospitals";' && \
          echo "    ‚úÖ Schema 'hospitals' created in hospital_service"
          
          # Ads service uses "ads" schema
          echo "  ‚Üí Creating 'ads' schema in ads_service..."
          docker exec postgres psql -U postgres -d ads_service -c 'CREATE SCHEMA IF NOT EXISTS "ads";' && \
          echo "    ‚úÖ Schema 'ads' created in ads_service"
          
          echo ""
          echo "=========================================="
          echo "‚úÖ Database setup completed!"
          echo "=========================================="
          echo ""
          echo "‚ÑπÔ∏è  Note: Prisma is used only as an ORM in this deployment."
          echo "   Database schema should be managed separately (e.g., via dump.sql)."
          echo ""
          
          echo "Starting all services (including admin-panel)..."
          $COMPOSE_CMD -f docker-compose.prod.yml up -d --remove-orphans
          
          echo "Waiting for services to start..."
          sleep 20
          
          # Check service status
          echo ""
          echo "Service status:"
          $COMPOSE_CMD -f docker-compose.prod.yml ps
          
          # Verify admin-panel is running
          echo ""
          echo "Verifying admin-panel status..."
          if docker ps --format "{{.Names}}" | grep -q "admin-panel"; then
            echo "‚úÖ admin-panel container is running"
            docker logs admin-panel --tail 20 || true
          else
            echo "‚ö†Ô∏è  admin-panel container not found, checking logs..."
            docker logs admin-panel --tail 50 || true
          fi
          
          # Show logs for any unhealthy services
          echo ""
          echo "Checking for unhealthy services..."
          UNHEALTHY=$(docker ps --filter "health=unhealthy" --format "{{.Names}}" || true)
          if [ ! -z "$UNHEALTHY" ]; then
            echo "‚ö†Ô∏è  Unhealthy services detected: $UNHEALTHY"
            for service in $UNHEALTHY; do
              echo "Logs for $service:"
              docker logs --tail 50 $service || true
            done
          fi
          
          echo ""
          echo "Creating admin user credentials..."
          # Wait a bit for user-service to be fully ready
          sleep 5
          
          # Try using the create-admin-manual.js script if it exists, otherwise use inline command
          if $COMPOSE_CMD -f docker-compose.prod.yml exec -T user-service test -f /app/create-admin-manual.js 2>/dev/null; then
            echo "Using create-admin-manual.js script..."
            $COMPOSE_CMD -f docker-compose.prod.yml exec -T user-service node /app/create-admin-manual.js || echo "‚ö†Ô∏è  Admin creation failed"
          else
            echo "Using inline command to create admin..."
            $COMPOSE_CMD -f docker-compose.prod.yml exec -T user-service node -e "const {PrismaClient}=require('@prisma/client');const bcrypt=require('bcryptjs');const p=new PrismaClient();(async()=>{try{const e=await p.user.findFirst({where:{role:'ADMIN'}});if(e){console.log('‚úÖ Admin exists:',e.username);}else{const h=await bcrypt.hash('admin123',10);const a=await p.user.create({data:{username:'0001',email:'admin@fayo.com',password:h,firstName:'System',lastName:'Administrator',role:'ADMIN',userType:'HOSPITAL_MANAGER',isActive:true}});console.log('‚úÖ Admin created! Username: 0001, Password: admin123, Email: admin@fayo.com');}}catch(e){console.error('‚ö†Ô∏è Error:',e.message);}finally{await p.\$disconnect();}})();" || echo "‚ö†Ô∏è  Admin creation failed"
          fi
          
          echo "Cleaning up unused images..."
          docker image prune -f || true
          
          echo "Final service status:"
          $COMPOSE_CMD -f docker-compose.prod.yml ps
          
          echo "‚úÖ Deployment process completed!"
          EOF

      - name: Check service logs (if any failures)
        continue-on-error: true
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
          echo "Checking service logs..."
          docker logs specialty-service --tail 50 || true
          echo ""
          docker logs admin-panel --tail 50 || true
          echo ""
          docker logs payment-service --tail 50 || true
          echo ""
          docker logs appointment-service --tail 50 || true
          echo ""
          echo "Checking all service status..."
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Health}}" | grep -E "NAMES|specialty|payment|appointment|admin-panel" || true
          EOF

      - name: Verify deployment
        continue-on-error: true
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
          echo "Final service status:"
          # Use the same compose command detection
          if docker compose version &> /dev/null; then
            docker compose -f /root/fayo/docker-compose.prod.yml ps
          else
            docker-compose -f /root/fayo/docker-compose.prod.yml ps
          fi
          EOF

